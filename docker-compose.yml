version: '3.8'

services:
  # ==================== FRONTEND ====================
  frontend:
    build:
      context: ./frontend/web
      dockerfile: Dockerfile
    ports:
      - "5173:5173"
    environment:
      - VITE_API_BASE=http://localhost:8787
      - VITE_AGENTS_WS=ws://localhost:3000
    volumes:
      - ./frontend/web/src:/app/src
    networks:
      - agenticdid-network
    depends_on:
      - api-gateway

  # ==================== BACKEND ====================
  
  # API Gateway (Main HTTP API)
  api-gateway:
    build:
      context: ./backend/api
      dockerfile: Dockerfile
    ports:
      - "8787:8787"
    environment:
      - NODE_ENV=development
      - AGENTS_RUNTIME_URL=http://agents-runtime:3000
      - MIDNIGHT_GATEWAY_URL=http://midnight-gateway:3001
      - TTS_SERVICE_URL=http://tts-service:3002
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    env_file:
      - .env
    volumes:
      - ./backend/api/src:/app/src
    networks:
      - agenticdid-network
    depends_on:
      - agents-runtime
      - midnight-gateway

  # Agents Runtime (Google ADK + Claude)
  agents-runtime:
    build:
      context: ./backend/agents-runtime
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS_JSON=${GOOGLE_APPLICATION_CREDENTIALS_JSON}
      - MIDNIGHT_GATEWAY_URL=http://midnight-gateway:3001
      - TTS_SERVICE_URL=http://tts-service:3002
      - ENABLE_LISTEN_IN_MODE=${ENABLE_LISTEN_IN_MODE}
    env_file:
      - .env
    volumes:
      - ./backend/agents-runtime/src:/app/src
    networks:
      - agenticdid-network

  # Midnight Gateway (Smart Contracts)
  midnight-gateway:
    build:
      context: ./backend/services/midnight-gateway
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - MIDNIGHT_RPC_URL=${MIDNIGHT_RPC_URL}
      - MIDNIGHT_CHAIN_ID=${MIDNIGHT_CHAIN_ID}
      - ENABLE_SPOOF_TRANSACTIONS=${ENABLE_SPOOF_TRANSACTIONS}
      - SPOOF_TRANSACTION_RATIO=${SPOOF_TRANSACTION_RATIO}
    env_file:
      - .env
    volumes:
      - ./backend/services/midnight-gateway/src:/app/src
      - ./protocol/contracts:/app/contracts:ro
    networks:
      - agenticdid-network

  # TTS Service (Google Cloud TTS)
  tts-service:
    build:
      context: ./backend/services/tts-service
      dockerfile: Dockerfile
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=development
      - GOOGLE_APPLICATION_CREDENTIALS_JSON=${GOOGLE_APPLICATION_CREDENTIALS_JSON}
      - TTS_PROVIDER=${TTS_PROVIDER}
      - TTS_VOICE_NAME=${TTS_VOICE_NAME}
      - TTS_LANGUAGE_CODE=${TTS_LANGUAGE_CODE}
    env_file:
      - .env
    volumes:
      - ./backend/services/tts-service/src:/app/src
    networks:
      - agenticdid-network

  # Credential Registry (Optional - Phase 2)
  credential-registry:
    build:
      context: ./backend/services/credential-registry
      dockerfile: Dockerfile
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    env_file:
      - .env
    volumes:
      - ./backend/services/credential-registry/src:/app/src
    networks:
      - agenticdid-network
    profiles:
      - full

  # ==================== DOCUMENTATION ====================
  docs:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./docs:/usr/share/nginx/html:ro
      - ../AgenticDID_DEMO-LAND/agentic-did/docs:/usr/share/nginx/html/demo:ro
    networks:
      - agenticdid-network

networks:
  agenticdid-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
