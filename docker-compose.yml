version: '3.8'

services:
  # ==================== BACKEND ====================
  
  # API Gateway (Main HTTP API)
  api-gateway:
    build:
      context: ./backend/api
      dockerfile: Dockerfile
    ports:
      - "8787:8787"
    environment:
      - NODE_ENV=development
      - AGENTS_RUNTIME_URL=http://agents-runtime:3001
      - MIDNIGHT_GATEWAY_URL=http://midnight-gateway:3003
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    env_file:
      - .env
    volumes:
      - ./backend/api/src:/app/src
    networks:
      - agenticdid-network
    depends_on:
      - agents-runtime
      - midnight-gateway

  # Agents Runtime (Google ADK + Claude)
  agents-runtime:
    build:
      context: ./backend/agents
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS_JSON=${GOOGLE_APPLICATION_CREDENTIALS_JSON}
      - MIDNIGHT_GATEWAY_URL=http://midnight-gateway:3003
      - ENABLE_LISTEN_IN_MODE=false
    env_file:
      - .env
    volumes:
      - ./backend/agents/src:/app/src
    networks:
      - agenticdid-network

  # Midnight Gateway (Smart Contracts)
  midnight-gateway:
    build:
      context: ./backend/midnight
      dockerfile: Dockerfile
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=development
      - MIDNIGHT_RPC_URL=${MIDNIGHT_RPC_URL}
      - MIDNIGHT_CHAIN_ID=${MIDNIGHT_CHAIN_ID}
      - ENABLE_SPOOF_TRANSACTIONS=${ENABLE_SPOOF_TRANSACTIONS}
      - SPOOF_TRANSACTION_RATIO=${SPOOF_TRANSACTION_RATIO}
    env_file:
      - .env
    volumes:
      - ./backend/midnight/src:/app/src
      - ./protocol/contracts:/app/contracts:ro
    networks:
      - agenticdid-network

  # TTS Service (Google Cloud TTS) - Commented out for now (optional service)
  # tts-service:
  #   build:
  #     context: ./backend/services/tts-service
  #     dockerfile: Dockerfile
  #   ports:
  #     - "3002:3002"
  #   environment:
  #     - NODE_ENV=development
  #     - GOOGLE_APPLICATION_CREDENTIALS_JSON=${GOOGLE_APPLICATION_CREDENTIALS_JSON}
  #     - TTS_PROVIDER=${TTS_PROVIDER}
  #     - TTS_VOICE_NAME=${TTS_VOICE_NAME}
  #     - TTS_LANGUAGE_CODE=${TTS_LANGUAGE_CODE}
  #   env_file:
  #     - .env
  #   volumes:
  #     - ./backend/services/tts-service/src:/app/src
  #   networks:
  #     - agenticdid-network

networks:
  agenticdid-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
